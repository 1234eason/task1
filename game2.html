<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048 遊戲 - HTML5 實現</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        
        header {
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            color: #FFD166;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            color: #ccc;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .score-container, .best-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
        }
        
        .score-label, .best-label {
            font-size: 1rem;
            color: #FFD166;
            margin-bottom: 5px;
        }
        
        .score, .best {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        button {
            padding: 12px 25px;
            background: #06D6A0;
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background: #05C490;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2);
        }
        
        .game-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .grid-cell {
            width: 100%;
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tile {
            position: absolute;
            width: calc(25% - 11.25px);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            border-radius: 8px;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        /* 不同數值的格子顏色 */
        .tile-2 { background-color: #EF476F; color: #fff; }
        .tile-4 { background-color: #FFD166; color: #1a1a2e; }
        .tile-8 { background-color: #06D6A0; color: #1a1a2e; }
        .tile-16 { background-color: #118AB2; color: #fff; }
        .tile-32 { background-color: #073B4C; color: #fff; }
        .tile-64 { background-color: #7209B7; color: #fff; }
        .tile-128 { background-color: #F72585; color: #fff; font-size: 1.8rem; }
        .tile-256 { background-color: #4CC9F0; color: #1a1a2e; font-size: 1.8rem; }
        .tile-512 { background-color: #4361EE; color: #fff; font-size: 1.8rem; }
        .tile-1024 { background-color: #3A0CA3; color: #fff; font-size: 1.5rem; }
        .tile-2048 { background-color: #FF9E00; color: #1a1a2e; font-size: 1.5rem; box-shadow: 0 0 20px rgba(255, 158, 0, 0.7); }
        
        .instructions {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
        }
        
        .instructions h3 {
            color: #06D6A0;
            margin-bottom: 10px;
        }
        
        .instructions p {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .game-message {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .game-message.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .game-message p {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #FFD166;
        }
        
        .mobile-controls {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
            max-width: 200px;
        }
        
        .mobile-controls button {
            width: 100%;
            padding: 15px;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .mobile-controls .up {
            grid-column: 2;
            grid-row: 1;
        }
        
        .mobile-controls .left {
            grid-column: 1;
            grid-row: 2;
        }
        
        .mobile-controls .right {
            grid-column: 3;
            grid-row: 2;
        }
        
        .mobile-controls .down {
            grid-column: 2;
            grid-row: 3;
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .tile {
                font-size: 1.5rem;
            }
            
            .tile-128, .tile-256, .tile-512 {
                font-size: 1.3rem;
            }
            
            .tile-1024, .tile-2048 {
                font-size: 1.2rem;
            }
            
            .mobile-controls {
                display: grid;
            }
        }
        
        footer {
            margin-top: 30px;
            color: #888;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>2048</h1>
            <p class="subtitle">使用方向鍵移動格子，當兩個相同數字的格子碰撞時，它們會合併成一個！</p>
        </header>
        
        <div class="game-info">
            <div class="score-container">
                <div class="score-label">分數</div>
                <div class="score">0</div>
            </div>
            <div class="best-container">
                <div class="best-label">最高分</div>
                <div class="best">0</div>
            </div>
        </div>
        
        <div class="controls">
            <button id="new-game">新遊戲</button>
            <button id="undo">復原</button>
        </div>
        
        <div class="game-container">
            <div class="grid-container" id="grid">
                <!-- 空格子將由JavaScript生成 -->
            </div>
            
            <div class="game-message" id="game-message">
                <p id="message-text"></p>
                <button id="try-again">再試一次</button>
            </div>
        </div>
        
        <div class="mobile-controls">
            <button class="up">↑</button>
            <button class="left">←</button>
            <button class="right">→</button>
            <button class="down">↓</button>
        </div>
        
        <div class="instructions">
            <h3>遊戲規則</h3>
            <p>1. 使用<b>方向鍵</b>或<b>觸控按鈕</b>移動格子</p>
            <p>2. 當兩個相同數字的格子碰撞時，它們會合併成一個，數字相加</p>
            <p>3. 每次移動後，會在隨機空位出現一個新的數字(2或4)</p>
            <p>4. 當你得到<b>2048</b>格子時獲勝！</p>
            <p>5. 當沒有空格子且無法合併時遊戲結束</p>
        </div>
        
        <footer>
            <p>© 2023 HTML5 2048 遊戲 | 所有數字完美保持在格子內</p>
        </footer>
    </div>

    <script>
        // 遊戲狀態變數
        let grid = [];
        let score = 0;
        let bestScore = localStorage.getItem('bestScore') || 0;
        let gameOver = false;
        let gameWon = false;
        let previousState = null;
        
        // DOM 元素
        const gridContainer = document.getElementById('grid');
        const scoreDisplay = document.querySelector('.score');
        const bestDisplay = document.querySelector('.best');
        const newGameButton = document.getElementById('new-game');
        const undoButton = document.getElementById('undo');
        const gameMessage = document.getElementById('game-message');
        const messageText = document.getElementById('message-text');
        const tryAgainButton = document.getElementById('try-again');
        
        // 初始化遊戲
        function initGame() {
            // 初始化網格
            grid = Array.from({ length: 4 }, () => Array(4).fill(0));
            
            // 重置遊戲狀態
            score = 0;
            gameOver = false;
            gameWon = false;
            previousState = null;
            
            // 更新分數顯示
            updateScore();
            
            // 隱藏遊戲消息
            gameMessage.classList.remove('active');
            
            // 清空格子容器
            gridContainer.innerHTML = '';
            
            // 創建網格格子
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    gridContainer.appendChild(cell);
                }
            }
            
            // 添加兩個初始數字
            addRandomTile();
            addRandomTile();
            
            // 渲染格子
            renderTiles();
        }
        
        // 添加隨機數字到空位
        function addRandomTile() {
            const emptyCells = [];
            
            // 找出所有空位
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    if (grid[row][col] === 0) {
                        emptyCells.push({ row, col });
                    }
                }
            }
            
            // 如果有空位，隨機選擇一個並添加數字
            if (emptyCells.length > 0) {
                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                // 90% 機率生成 2，10% 機率生成 4
                grid[randomCell.row][randomCell.col] = Math.random() < 0.9 ? 2 : 4;
            }
        }
        
        // 渲染所有數字格子
        function renderTiles() {
            // 移除現有的數字格子
            const existingTiles = document.querySelectorAll('.tile');
            existingTiles.forEach(tile => tile.remove());
            
            // 創建新的數字格子
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const value = grid[row][col];
                    if (value !== 0) {
                        const tile = document.createElement('div');
                        tile.classList.add('tile', `tile-${value}`);
                        tile.textContent = value;
                        
                        // 計算位置（確保完全在格子內）
                        const cellSize = gridContainer.clientWidth / 4;
                        const gap = 15; // 與CSS中的gap一致
                        
                        // 計算位置，確保完全在格子內
                        tile.style.width = `calc(25% - ${gap * 3 / 4}px)`;
                        tile.style.left = `calc(${col} * (25% + ${gap / 4}px) + ${gap / 2}px)`;
                        tile.style.top = `calc(${row} * (25% + ${gap / 4}px) + ${gap / 2}px)`;
                        
                        gridContainer.appendChild(tile);
                    }
                }
            }
        }
        
        // 保存當前狀態（用於復原功能）
        function saveState() {
            previousState = {
                grid: grid.map(row => [...row]),
                score: score
            };
        }
        
        // 復原到上一步
        function undoMove() {
            if (previousState) {
                grid = previousState.grid.map(row => [...row]);
                score = previousState.score;
                previousState = null;
                updateScore();
                renderTiles();
                gameOver = false;
                gameWon = false;
                gameMessage.classList.remove('active');
            }
        }
        
        // 移動數字
        function move(direction) {
            // 如果遊戲結束，不處理移動
            if (gameOver) return false;
            
            // 保存當前狀態
            saveState();
            
            let moved = false;
            const newGrid = grid.map(row => [...row]);
            
            // 根據方向處理移動
            if (direction === 'left') {
                for (let row = 0; row < 4; row++) {
                    const result = slideAndMerge(newGrid[row]);
                    newGrid[row] = result.row;
                    if (result.moved) moved = true;
                }
            } else if (direction === 'right') {
                for (let row = 0; row < 4; row++) {
                    const reversed = [...newGrid[row]].reverse();
                    const result = slideAndMerge(reversed);
                    newGrid[row] = result.row.reverse();
                    if (result.moved) moved = true;
                }
            } else if (direction === 'up') {
                for (let col = 0; col < 4; col++) {
                    const column = [
                        newGrid[0][col],
                        newGrid[1][col],
                        newGrid[2][col],
                        newGrid[3][col]
                    ];
                    const result = slideAndMerge(column);
                    if (result.moved) moved = true;
                    for (let row = 0; row < 4; row++) {
                        newGrid[row][col] = result.row[row];
                    }
                }
            } else if (direction === 'down') {
                for (let col = 0; col < 4; col++) {
                    const column = [
                        newGrid[3][col],
                        newGrid[2][col],
                        newGrid[1][col],
                        newGrid[0][col]
                    ];
                    const result = slideAndMerge(column);
                    if (result.moved) moved = true;
                    const newColumn = result.row;
                    for (let row = 0; row < 4; row++) {
                        newGrid[3 - row][col] = newColumn[row];
                    }
                }
            }
            
            // 如果有移動發生，更新網格並添加新數字
            if (moved) {
                grid = newGrid;
                addRandomTile();
                renderTiles();
                updateScore();
                checkGameStatus();
            }
            
            return moved;
        }
        
        // 滑動並合併一行/一列
        function slideAndMerge(row) {
            let moved = false;
            
            // 過濾掉零（空位）
            const filtered = row.filter(val => val !== 0);
            
            // 合併相同數字
            for (let i = 0; i < filtered.length - 1; i++) {
                if (filtered[i] === filtered[i + 1]) {
                    filtered[i] *= 2;
                    filtered[i + 1] = 0;
                    score += filtered[i];
                    
                    // 檢查是否達到2048
                    if (filtered[i] === 2048) {
                        gameWon = true;
                    }
                }
            }
            
            // 再次過濾掉零
            const merged = filtered.filter(val => val !== 0);
            
            // 用零填充剩餘位置
            while (merged.length < 4) {
                merged.push(0);
            }
            
            // 檢查是否發生了移動
            for (let i = 0; i < 4; i++) {
                if (row[i] !== merged[i]) {
                    moved = true;
                    break;
                }
            }
            
            return { row: merged, moved };
        }
        
        // 更新分數顯示
        function updateScore() {
            scoreDisplay.textContent = score;
            bestDisplay.textContent = bestScore;
            
            // 更新最高分
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('bestScore', bestScore);
                bestDisplay.textContent = bestScore;
            }
        }
        
        // 檢查遊戲狀態
        function checkGameStatus() {
            // 檢查是否獲勝
            if (gameWon && !gameOver) {
                messageText.textContent = '恭喜！你達到了2048！';
                gameMessage.classList.add('active');
                return;
            }
            
            // 檢查是否還有空位
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    if (grid[row][col] === 0) {
                        return; // 還有空位，遊戲繼續
                    }
                }
            }
            
            // 檢查是否還可以合併
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const value = grid[row][col];
                    
                    // 檢查右側和下側的格子是否相同
                    if (col < 3 && grid[row][col + 1] === value) {
                        return; // 可以水平合併
                    }
                    
                    if (row < 3 && grid[row + 1][col] === value) {
                        return; // 可以垂直合併
                    }
                }
            }
            
            // 遊戲結束
            gameOver = true;
            messageText.textContent = '遊戲結束！';
            gameMessage.classList.add('active');
        }
        
        // 事件監聽器
        document.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowLeft') {
                move('left');
            } else if (event.key === 'ArrowRight') {
                move('right');
            } else if (event.key === 'ArrowUp') {
                move('up');
            } else if (event.key === 'ArrowDown') {
                move('down');
            }
        });
        
        newGameButton.addEventListener('click', initGame);
        undoButton.addEventListener('click', undoMove);
        tryAgainButton.addEventListener('click', initGame);
        
        // 移動端控制按鈕
        document.querySelector('.mobile-controls .up').addEventListener('click', () => move('up'));
        document.querySelector('.mobile-controls .down').addEventListener('click', () => move('down'));
        document.querySelector('.mobile-controls .left').addEventListener('click', () => move('left'));
        document.querySelector('.mobile-controls .right').addEventListener('click', () => move('right'));
        
        // 初始化遊戲
        initGame();
    </script>
</body>
</html>